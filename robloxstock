name: Update RBLX Price

# Run every day at midnight local time
on:
  schedule:
    - cron: "0 0 * * *" # UTC midnight, adjust as needed
  workflow_dispatch: # allows manual run

jobs:
  update-price:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch & save RBLX price to Roblox
        env:
          ROBLOX_API_KEY: ${{ secrets.ROBLOX_API_KEY }}
          UNIVERSE_ID: ${{ secrets.UNIVERSE_ID }}
          ALPHA_KEY: ${{ secrets.ALPHA_KEY }}
        run: |
          node << 'EOF'
          const fetch = (...args) => import('node-fetch').then(({default: fetch}) => fetch(...args));

          const SYMBOL = "RBLX";
          const DATASTORE = "GlobalRBLXPrices_v2";
          const ENTRY_KEY = "DATA";

          async function run() {
            // 1️⃣ Fetch price from Alpha Vantage
            const res = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${SYMBOL}&apikey=${process.env.ALPHA_KEY}`);
            const json = await res.json();
            const price = Number(json["Global Quote"]["05. price"]);
            if (!price) throw "No price returned";

            // 2️⃣ Load existing DataStore entry
            const url = `https://apis.roblox.com/datastores/v1/universes/${process.env.UNIVERSE_ID}/standard-datastores/datastore/entries/entry?datastoreName=${DATASTORE}&entryKey=${ENTRY_KEY}`;
            const headers = { "x-api-key": process.env.ROBLOX_API_KEY };

            let data = { lastDay: null, prices: [] };
            const getRes = await fetch(url, { headers });
            if (getRes.ok) data = await getRes.json();

            // 3️⃣ Avoid duplicate entry for today
            const today = new Date().toISOString().split("T")[0];
            if (data.lastDay === today) return console.log("Already updated today");

            // 4️⃣ Add today's price
            data.prices.push({ date: `${today} 00:00:00`, price });
            data.lastDay = today;

            // 5️⃣ Save back to Roblox DataStore
            const saveRes = await fetch(url, {
              method: "POST",
              headers: { ...headers, "Content-Type": "application/json" },
              body: JSON.stringify(data)
            });

            if (!saveRes.ok) throw `Failed to save: ${saveRes.statusText}`;
            console.log("Price saved:", price);
          }

          run().catch(err => {
            console.error(err);
            process.exit(1);
          });
          EOF
